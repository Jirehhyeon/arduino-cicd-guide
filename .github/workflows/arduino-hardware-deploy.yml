# ðŸ¤– Arduino í•˜ë“œì›¨ì–´ ìžë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°

name: ðŸ”§ Arduino Hardware CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'examples/**/*.ino'
      - 'src/**/*.cpp'
      - 'src/**/*.h'
      - 'hardware/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:
        description: 'ë°°í¬ ëŒ€ìƒ ë””ë°”ì´ìŠ¤'
        required: true
        default: 'esp32_greenhouse'
        type: choice
        options:
        - esp32_greenhouse
        - esp32_weather_station
        - esp32_security_system
      deploy_mode:
        description: 'ë°°í¬ ëª¨ë“œ'
        required: true
        default: 'ota'
        type: choice
        options:
        - ota
        - serial
        - mass_deploy

env:
  ARDUINO_CLI_VERSION: "0.35.3"
  ESP32_CORE_VERSION: "2.0.14"
  PROJECT_NAME: "smart-greenhouse"

jobs:
  # ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ðŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ Arduino CLI ì„¤ì¹˜
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: âš™ï¸ Arduino CLI ì„¤ì •
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}

    - name: ðŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      run: |
        arduino-cli lib install "DHT sensor library"
        arduino-cli lib install "Adafruit NeoPixel"
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "PubSubClient"
        arduino-cli lib install "WiFiManager"
        arduino-cli lib install "ArduinoOTA"

    - name: ðŸ” ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
      run: |
        echo "ðŸŽ¨ Arduino ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ì‹œìž‘..."
        
        # ê¸°ë³¸ ë¬¸ë²• ê²€ì‚¬
        find . -name "*.ino" -o -name "*.cpp" -o -name "*.h" | while read file; do
          echo "ê²€ì‚¬ ì¤‘: $file"
          
          # íƒ­ vs ìŠ¤íŽ˜ì´ìŠ¤ ì¼ê´€ì„± ê²€ì‚¬
          if grep -P '\t' "$file" >/dev/null && grep -P '^  ' "$file" >/dev/null; then
            echo "âš ï¸ íƒ­ê³¼ ìŠ¤íŽ˜ì´ìŠ¤ê°€ í˜¼ìž¬: $file"
          fi
          
          # ê¸´ ì¤„ ê²€ì‚¬ (120ìž ì œí•œ)
          if awk 'length > 120 {print NR ": " $0}' "$file" | head -5; then
            echo "âš ï¸ 120ìžë¥¼ ì´ˆê³¼í•˜ëŠ” ì¤„ì´ ìžˆìŠµë‹ˆë‹¤: $file"
          fi
          
          # í•œê¸€ ì£¼ì„ ì¸ì½”ë”© ê²€ì‚¬
          if file "$file" | grep -v UTF-8 >/dev/null; then
            echo "âš ï¸ UTF-8 ì¸ì½”ë”©ì´ ì•„ë‹™ë‹ˆë‹¤: $file"
          fi
        done

    - name: ðŸ”¬ ì •ì  ë¶„ì„ (cppcheck)
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
        
        echo "ðŸ”¬ C++ ì •ì  ë¶„ì„ ì‹œìž‘..."
        find . -name "*.cpp" -o -name "*.h" | xargs cppcheck \
          --enable=warning,style,performance,portability \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --quiet || true

    - name: ðŸ“ˆ ì½”ë“œ ë³µìž¡ë„ ë¶„ì„
      run: |
        echo "ðŸ“ˆ ì½”ë“œ ë³µìž¡ë„ ë¶„ì„..."
        
        # í•¨ìˆ˜ë³„ ë¼ì¸ ìˆ˜ ì²´í¬
        find . -name "*.ino" -o -name "*.cpp" | while read file; do
          echo "=== $file ==="
          awk '/^[a-zA-Z_][a-zA-Z0-9_]*.*\{/{func=$0; lines=1; next} 
               /\{/{braces++} 
               /\}/{braces--; if(braces==0 && func){print func ": " lines " lines"; func=""}} 
               func{lines++}' "$file"
        done

    - name: ðŸ“‹ ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬
      run: |
        echo "ðŸ”’ ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬..."
        
        # í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸/í‚¤ ê²€ì‚¬
        if grep -r -i "password.*=.*\"" --include="*.ino" --include="*.cpp" --include="*.h" .; then
          echo "âš ï¸ í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        fi
        
        # WiFi ìžê²©ì¦ëª… í•˜ë“œì½”ë”© ê²€ì‚¬
        if grep -r "WiFi.begin.*\".*\".*\".*\"" --include="*.ino" .; then
          echo "âš ï¸ WiFi ìžê²©ì¦ëª…ì´ í•˜ë“œì½”ë”©ë˜ì–´ ìžˆìŠµë‹ˆë‹¤!"
        fi
        
        # ë””ë²„ê·¸ ì •ë³´ ìœ ì¶œ ê²€ì‚¬
        if grep -r "Serial.print.*password\|Serial.print.*key" --include="*.ino" --include="*.cpp" .; then
          echo "âš ï¸ ë¯¼ê°í•œ ì •ë³´ê°€ ì‹œë¦¬ì–¼ë¡œ ì¶œë ¥ë˜ê³  ìžˆìŠµë‹ˆë‹¤!"
        fi

  # ðŸ—ï¸ ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸
  compile-test:
    name: ðŸ—ï¸ Multi-Platform Compile Test
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        board:
          - esp32:esp32:esp32doit-devkit-v1
          - esp32:esp32:esp32s2
          - esp32:esp32:esp32s3
          - esp32:esp32:esp32c3
        example:
          - examples/temperature-monitoring/src/main
          - examples/smart-greenhouse/src/main
          - examples/weather-station/src/main

    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ðŸ”§ Arduino CLI ì„¤ì •
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$HOME/bin" >> $GITHUB_PATH
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}

    - name: ðŸ“š ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      run: |
        arduino-cli lib install "DHT sensor library@1.4.4"
        arduino-cli lib install "Adafruit NeoPixel@1.11.0"
        arduino-cli lib install "ArduinoJson@6.21.3"
        arduino-cli lib install "PubSubClient@2.8"
        arduino-cli lib install "WiFiManager@2.0.16-rc.2"
        arduino-cli lib install "ArduinoOTA@1.0"
        arduino-cli lib install "AsyncTCP@1.1.1"
        arduino-cli lib install "ESPAsyncWebServer@1.2.3"

    - name: ðŸ—ï¸ ì»´íŒŒì¼ ì‹¤í–‰
      run: |
        echo "ðŸ—ï¸ ${{ matrix.board }}ì—ì„œ ${{ matrix.example }} ì»´íŒŒì¼ ì¤‘..."
        
        if [ -f "${{ matrix.example }}.ino" ]; then
          # ë³´ë“œë³„ íŠ¹ë³„ ì„¤ì •
          case "${{ matrix.board }}" in
            *esp32s2*)
              EXTRA_FLAGS="--build-property build.defines=-DARDUINO_USB_CDC_ON_BOOT=1"
              ;;
            *esp32s3*)
              EXTRA_FLAGS="--build-property build.defines=-DARDUINO_USB_CDC_ON_BOOT=1"
              ;;
            *esp32c3*)
              EXTRA_FLAGS="--build-property build.defines=-DARDUINO_USB_CDC_ON_BOOT=1"
              ;;
            *)
              EXTRA_FLAGS=""
              ;;
          esac
          
          arduino-cli compile \
            --fqbn ${{ matrix.board }} \
            --output-dir ./build/${{ matrix.board }} \
            --export-binaries \
            $EXTRA_FLAGS \
            "${{ matrix.example }}.ino"
            
          echo "âœ… ì»´íŒŒì¼ ì„±ê³µ!"
          
          # ë°”ì´ë„ˆë¦¬ í¬ê¸° í™•ì¸
          ls -la ./build/${{ matrix.board }}/*.bin
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„ì„
          arduino-cli compile \
            --fqbn ${{ matrix.board }} \
            --verbose \
            "${{ matrix.example }}.ino" 2>&1 | grep -E "Sketch uses|Global variables"
            
        else
          echo "âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ matrix.example }}.ino"
          exit 1
        fi

    - name: ðŸ“Š ë°”ì´ë„ˆë¦¬ ë¶„ì„
      run: |
        echo "ðŸ“Š ë°”ì´ë„ˆë¦¬ íŒŒì¼ ë¶„ì„..."
        
        if [ -d "./build/${{ matrix.board }}" ]; then
          cd "./build/${{ matrix.board }}"
          
          for bin_file in *.bin; do
            if [ -f "$bin_file" ]; then
              echo "=== $bin_file ==="
              echo "íŒŒì¼ í¬ê¸°: $(stat -c%s "$bin_file") bytes"
              echo "SHA256: $(sha256sum "$bin_file" | cut -d' ' -f1)"
              echo
            fi
          done
        fi

    - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.board }}-${{ github.run_number }}
        path: |
          ./build/**/*.bin
          ./build/**/*.elf
          ./build/**/*.hex
        retention-days: 30

  # ðŸ§ª í•˜ë“œì›¨ì–´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
  hardware-simulation:
    name: ðŸ§ª Hardware Simulation Test
    runs-on: ubuntu-latest
    needs: compile-test
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ðŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install --upgrade pip
        pip install pytest pytest-asyncio
        pip install pyserial
        pip install paho-mqtt
        pip install requests
        pip install numpy
        pip install matplotlib

    - name: ðŸ¤– Wokwi ì‹œë®¬ë ˆì´í„° ì„¤ì •
      run: |
        echo "ðŸ¤– Wokwi CLI ì„¤ì¹˜..."
        npm install -g @wokwi/cli
        
        # ì‹œë®¬ë ˆì´ì…˜ í”„ë¡œì íŠ¸ íŒŒì¼ ìƒì„±
        cat > diagram.json << 'EOF'
        {
          "version": 1,
          "author": "Arduino CI/CD Guide",
          "editor": "wokwi",
          "parts": [
            { "type": "wokwi-esp32-devkit-v1", "id": "esp", "top": 0, "left": 0, "attrs": {} },
            { "type": "wokwi-dht22", "id": "dht", "top": 0, "left": 200, "attrs": {} },
            { "type": "wokwi-led", "id": "led1", "top": 100, "left": 200, "attrs": { "color": "red" } },
            { "type": "wokwi-led", "id": "led2", "top": 150, "left": 200, "attrs": { "color": "green" } },
            { "type": "wokwi-resistor", "id": "r1", "top": 100, "left": 150, "attrs": { "value": "220" } }
          ],
          "connections": [
            [ "esp:TX0", "$serialMonitor:RX", "", [] ],
            [ "esp:RX0", "$serialMonitor:TX", "", [] ],
            [ "esp:D2", "dht:SDA", "green", [ "h0" ] ],
            [ "esp:3V3", "dht:VCC", "red", [ "v0" ] ],
            [ "esp:GND.1", "dht:GND", "black", [ "v0" ] ],
            [ "esp:D4", "r1:1", "green", [ "h0" ] ],
            [ "r1:2", "led1:A", "green", [ "h0" ] ],
            [ "led1:C", "esp:GND.2", "black", [ "h0" ] ]
          ]
        }
        EOF

    - name: ðŸ§ª í•˜ë“œì›¨ì–´ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
      run: |
        echo "ðŸ§ª ESP32 ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹œìž‘..."
        
        # Python ì‹œë®¬ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > hardware_test.py << 'EOF'
        import time
        import json
        import subprocess
        import threading
        from unittest.mock import Mock

        class ESP32Simulator:
            def __init__(self):
                self.sensors = {
                    'temperature': 25.0,
                    'humidity': 60.0,
                    'soil_moisture': 2500,
                    'light_level': 1500
                }
                self.actuators = {
                    'pump_relay': False,
                    'fan_relay': False,
                    'led_strip': [0, 0, 0]  # RGB
                }
                self.wifi_connected = False
                
            def read_dht22(self):
                """DHT22 ì„¼ì„œ ì‹œë®¬ë ˆì´ì…˜"""
                # ì‹¤ì œ í™˜ê²½ ë³€í™” ì‹œë®¬ë ˆì´ì…˜
                import random
                temp_variation = random.uniform(-1, 1)
                humid_variation = random.uniform(-2, 2)
                
                self.sensors['temperature'] += temp_variation
                self.sensors['humidity'] += humid_variation
                
                # ë²”ìœ„ ì œí•œ
                self.sensors['temperature'] = max(15, min(35, self.sensors['temperature']))
                self.sensors['humidity'] = max(30, min(90, self.sensors['humidity']))
                
                return self.sensors['temperature'], self.sensors['humidity']
                
            def read_soil_moisture(self):
                """í† ì–‘ ìˆ˜ë¶„ ì„¼ì„œ ì‹œë®¬ë ˆì´ì…˜"""
                # ê¸‰ìˆ˜ í›„ ìˆ˜ë¶„ ì¦ê°€ ì‹œë®¬ë ˆì´ì…˜
                if self.actuators['pump_relay']:
                    self.sensors['soil_moisture'] -= 50  # ìŠµí•´ì§
                else:
                    self.sensors['soil_moisture'] += 5   # ì„œì„œížˆ ê±´ì¡°
                    
                self.sensors['soil_moisture'] = max(500, min(4000, self.sensors['soil_moisture']))
                return self.sensors['soil_moisture']
                
            def read_light_sensor(self):
                """ì¡°ë„ ì„¼ì„œ ì‹œë®¬ë ˆì´ì…˜"""
                import random
                # ì‹œê°„ì— ë”°ë¥¸ ì¡°ë„ ë³€í™” ì‹œë®¬ë ˆì´ì…˜
                base_light = 2000 + random.uniform(-500, 500)
                self.sensors['light_level'] = max(0, min(4095, base_light))
                return self.sensors['light_level']
                
            def control_pump(self, state):
                """ì›Œí„°íŽŒí”„ ì œì–´"""
                self.actuators['pump_relay'] = state
                print(f"ðŸ’§ ì›Œí„°íŽŒí”„: {'ON' if state else 'OFF'}")
                
            def control_fan(self, state):
                """íŒ¬ ì œì–´"""
                self.actuators['fan_relay'] = state
                print(f"ðŸŒªï¸ íŒ¬: {'ON' if state else 'OFF'}")
                
            def control_led(self, r, g, b):
                """LED ìŠ¤íŠ¸ë¦½ ì œì–´"""
                self.actuators['led_strip'] = [r, g, b]
                print(f"ðŸ’¡ LED: RGB({r}, {g}, {b})")
                
            def connect_wifi(self, ssid, password):
                """WiFi ì—°ê²° ì‹œë®¬ë ˆì´ì…˜"""
                print(f"ðŸ“¶ WiFi ì—°ê²° ì‹œë„: {ssid}")
                time.sleep(2)  # ì—°ê²° ì§€ì—° ì‹œë®¬ë ˆì´ì…˜
                self.wifi_connected = True
                print("âœ… WiFi ì—°ê²° ì„±ê³µ")
                return "192.168.1.100"  # ê°€ìƒ IP
                
            def auto_control_logic(self):
                """ìžë™ ì œì–´ ë¡œì§ í…ŒìŠ¤íŠ¸"""
                temp, humid = self.read_dht22()
                soil = self.read_soil_moisture()
                light = self.read_light_sensor()
                
                print(f"ðŸ“Š ì„¼ì„œ ë°ì´í„°: ì˜¨ë„={temp:.1f}Â°C, ìŠµë„={humid:.1f}%, í† ì–‘={soil}, ì¡°ë„={light}")
                
                # ìžë™ ê¸‰ìˆ˜ ë¡œì§
                if soil > 3000:
                    print("ðŸŒ± í† ì–‘ì´ ê±´ì¡°í•¨ - ìžë™ ê¸‰ìˆ˜ ì‹œìž‘")
                    self.control_pump(True)
                    time.sleep(1)  # 1ì´ˆê°„ ê¸‰ìˆ˜
                    self.control_pump(False)
                    
                # ìžë™ í™˜ê¸° ë¡œì§
                if temp > 28:
                    self.control_fan(True)
                elif temp < 24:
                    self.control_fan(False)
                    
                # LED ìƒ‰ìƒ ì œì–´
                if temp < 20:
                    self.control_led(0, 0, 255)    # íŒŒëž€ìƒ‰
                elif temp < 25:
                    self.control_led(0, 255, 0)    # ì´ˆë¡ìƒ‰
                elif temp < 30:
                    self.control_led(255, 255, 0)  # ë…¸ëž€ìƒ‰
                else:
                    self.control_led(255, 0, 0)    # ë¹¨ê°„ìƒ‰

        def test_hardware_simulation():
            """í•˜ë“œì›¨ì–´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸"""
            print("ðŸ§ª ESP32 ìŠ¤ë§ˆíŠ¸ ì˜¨ì‹¤ ì‹œë®¬ë ˆì´ì…˜ ì‹œìž‘")
            
            esp32 = ESP32Simulator()
            
            # WiFi ì—°ê²° í…ŒìŠ¤íŠ¸
            ip = esp32.connect_wifi("TestNetwork", "password123")
            assert esp32.wifi_connected == True
            
            # ì„¼ì„œ ì½ê¸° í…ŒìŠ¤íŠ¸
            for i in range(10):
                print(f"\n=== ì‹œë®¬ë ˆì´ì…˜ ì‚¬ì´í´ {i+1} ===")
                esp32.auto_control_logic()
                time.sleep(0.5)
                
            print("\nâœ… í•˜ë“œì›¨ì–´ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ")

        if __name__ == "__main__":
            test_hardware_simulation()
        EOF
        
        python hardware_test.py

    - name: ðŸ“¡ MQTT í†µì‹  í…ŒìŠ¤íŠ¸
      run: |
        echo "ðŸ“¡ MQTT í†µì‹  ì‹œë®¬ë ˆì´ì…˜..."
        
        cat > mqtt_test.py << 'EOF'
        import json
        import time
        import threading
        from unittest.mock import Mock

        class MQTTSimulator:
            def __init__(self):
                self.connected = False
                self.subscriptions = {}
                self.published_messages = []
                
            def connect(self, broker, port=1883):
                print(f"ðŸ“¡ MQTT ë¸Œë¡œì»¤ ì—°ê²°: {broker}:{port}")
                time.sleep(1)
                self.connected = True
                return True
                
            def subscribe(self, topic, callback):
                print(f"ðŸ“¥ í† í”½ êµ¬ë…: {topic}")
                self.subscriptions[topic] = callback
                
            def publish(self, topic, payload):
                print(f"ðŸ“¤ ë©”ì‹œì§€ ë°œí–‰: {topic} -> {payload}")
                self.published_messages.append({
                    'topic': topic,
                    'payload': payload,
                    'timestamp': time.time()
                })
                
            def simulate_incoming_message(self, topic, payload):
                if topic in self.subscriptions:
                    self.subscriptions[topic](payload)

        def test_mqtt_communication():
            print("ðŸ“¡ MQTT í†µì‹  í…ŒìŠ¤íŠ¸ ì‹œìž‘")
            
            mqtt = MQTTSimulator()
            
            # ì—°ê²° í…ŒìŠ¤íŠ¸
            assert mqtt.connect("test.mosquitto.org") == True
            
            # êµ¬ë… í…ŒìŠ¤íŠ¸
            def on_control_message(payload):
                data = json.loads(payload)
                print(f"ðŸŽ›ï¸ ì œì–´ ëª…ë ¹ ìˆ˜ì‹ : {data}")
                
            mqtt.subscribe("greenhouse/control", on_control_message)
            
            # ë°œí–‰ í…ŒìŠ¤íŠ¸
            sensor_data = {
                "temperature": 25.5,
                "humidity": 65.2,
                "soil_moisture": 2800,
                "timestamp": int(time.time())
            }
            mqtt.publish("greenhouse/sensors", json.dumps(sensor_data))
            
            # ì œì–´ ëª…ë ¹ ì‹œë®¬ë ˆì´ì…˜
            control_cmd = {"device": "pump", "action": "on", "duration": 3000}
            mqtt.simulate_incoming_message("greenhouse/control", json.dumps(control_cmd))
            
            print("âœ… MQTT í†µì‹  í…ŒìŠ¤íŠ¸ ì™„ë£Œ")

        if __name__ == "__main__":
            test_mqtt_communication()
        EOF
        
        python mqtt_test.py

  # ðŸš€ ìžë™ ë°°í¬
  deploy:
    name: ðŸš€ Automated Hardware Deployment
    runs-on: ubuntu-latest
    needs: [compile-test, hardware-simulation]
    if: github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        device:
          - name: "greenhouse-001"
            ip: "192.168.1.100"
            board: "esp32:esp32:esp32doit-devkit-v1"
          - name: "greenhouse-002"  
            ip: "192.168.1.101"
            board: "esp32:esp32:esp32doit-devkit-v1"
          - name: "weather-station-001"
            ip: "192.168.1.102"
            board: "esp32:esp32:esp32s3"

    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ðŸ“¦ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: firmware-${{ matrix.device.board }}-${{ github.run_number }}
        path: ./firmware

    - name: ðŸ”§ ESP32 ë„êµ¬ ì„¤ì¹˜
      run: |
        # esptools ì„¤ì¹˜
        pip install esptool
        
        # OTA ë°°í¬ë¥¼ ìœ„í•œ ë„êµ¬ ì„¤ì¹˜
        pip install requests
        pip install paramiko  # SSH/SCP ì§€ì›

    - name: ðŸŒ ë””ë°”ì´ìŠ¤ ì—°ê²° í™•ì¸
      run: |
        echo "ðŸŒ ${{ matrix.device.name }} ì—°ê²° í™•ì¸ ì¤‘..."
        
        # ë””ë°”ì´ìŠ¤ ping í…ŒìŠ¤íŠ¸
        if ping -c 3 ${{ matrix.device.ip }}; then
          echo "âœ… ${{ matrix.device.name }} ì˜¨ë¼ì¸"
        else
          echo "âŒ ${{ matrix.device.name }} ì˜¤í”„ë¼ì¸ - ë°°í¬ ê±´ë„ˆëœ€"
          exit 0
        fi
        
        # HTTP ìƒíƒœ í™•ì¸
        if curl -s --timeout 5 http://${{ matrix.device.ip }}/status; then
          echo "âœ… HTTP ì„œë¹„ìŠ¤ ì •ìƒ"
        else
          echo "âš ï¸ HTTP ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ"
        fi

    - name: ðŸ“Š í˜„ìž¬ íŽŒì›¨ì–´ ì •ë³´ ìˆ˜ì§‘
      run: |
        echo "ðŸ“Š í˜„ìž¬ íŽŒì›¨ì–´ ì •ë³´ ìˆ˜ì§‘..."
        
        cat > get_device_info.py << 'EOF'
        import requests
        import json
        import sys

        def get_device_info(ip):
            try:
                # í˜„ìž¬ íŽŒì›¨ì–´ ë²„ì „ í™•ì¸
                response = requests.get(f"http://{ip}/api/info", timeout=10)
                if response.status_code == 200:
                    info = response.json()
                    print(f"í˜„ìž¬ ë²„ì „: {info.get('version', 'unknown')}")
                    print(f"ë¹Œë“œ ì‹œê°„: {info.get('build_time', 'unknown')}")
                    print(f"ì—…íƒ€ìž„: {info.get('uptime', 'unknown')}")
                    print(f"ìžìœ  ë©”ëª¨ë¦¬: {info.get('free_heap', 'unknown')} bytes")
                    return info
                else:
                    print(f"âŒ API ì‘ë‹µ ì˜¤ë¥˜: {response.status_code}")
                    return None
            except Exception as e:
                print(f"âŒ ì—°ê²° ì˜¤ë¥˜: {e}")
                return None

        if __name__ == "__main__":
            device_ip = sys.argv[1] if len(sys.argv) > 1 else "192.168.1.100"
            info = get_device_info(device_ip)
        EOF
        
        python get_device_info.py ${{ matrix.device.ip }} || true

    - name: ðŸ”„ OTA ë°°í¬ ì‹¤í–‰
      run: |
        echo "ðŸ”„ ${{ matrix.device.name }}ì— OTA ë°°í¬ ì‹œìž‘..."
        
        cat > ota_deploy.py << 'EOF'
        import requests
        import time
        import sys
        import os

        def deploy_ota(ip, firmware_path):
            print(f"ðŸš€ OTA ë°°í¬ ì‹œìž‘: {ip}")
            
            # íŽŒì›¨ì–´ íŒŒì¼ í™•ì¸
            if not os.path.exists(firmware_path):
                print(f"âŒ íŽŒì›¨ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {firmware_path}")
                return False
                
            file_size = os.path.getsize(firmware_path)
            print(f"ðŸ“¦ íŽŒì›¨ì–´ í¬ê¸°: {file_size} bytes")
            
            try:
                # OTA ëª¨ë“œ í™œì„±í™”
                print("ðŸ”„ OTA ëª¨ë“œ í™œì„±í™”...")
                response = requests.post(f"http://{ip}/api/ota/begin", 
                                       json={"size": file_size}, 
                                       timeout=30)
                if response.status_code != 200:
                    print(f"âŒ OTA ì‹œìž‘ ì‹¤íŒ¨: {response.status_code}")
                    return False
                    
                # íŽŒì›¨ì–´ ì—…ë¡œë“œ
                print("ðŸ“¤ íŽŒì›¨ì–´ ì—…ë¡œë“œ ì¤‘...")
                with open(firmware_path, 'rb') as f:
                    files = {'firmware': f}
                    response = requests.post(f"http://{ip}/api/ota/upload", 
                                           files=files, 
                                           timeout=120)
                    if response.status_code != 200:
                        print(f"âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: {response.status_code}")
                        return False
                        
                # ìž¬ë¶€íŒ… ë° ì ìš©
                print("ðŸ”„ ìž¬ë¶€íŒ… ë° íŽŒì›¨ì–´ ì ìš©...")
                requests.post(f"http://{ip}/api/ota/reboot", timeout=5)
                
                # ìž¬ë¶€íŒ… ëŒ€ê¸°
                print("â³ ìž¬ë¶€íŒ… ëŒ€ê¸° ì¤‘...")
                time.sleep(30)
                
                # ìž¬ì—°ê²° í™•ì¸
                for attempt in range(10):
                    try:
                        response = requests.get(f"http://{ip}/api/info", timeout=5)
                        if response.status_code == 200:
                            info = response.json()
                            print(f"âœ… ë°°í¬ ì™„ë£Œ! ìƒˆ ë²„ì „: {info.get('version', 'unknown')}")
                            return True
                    except:
                        print(f"ðŸ”„ ìž¬ì—°ê²° ì‹œë„ {attempt + 1}/10...")
                        time.sleep(5)
                        
                print("âŒ ìž¬ì—°ê²° ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”")
                return False
                
            except Exception as e:
                print(f"âŒ OTA ë°°í¬ ì˜¤ë¥˜: {e}")
                return False

        if __name__ == "__main__":
            device_ip = sys.argv[1]
            firmware_file = sys.argv[2]
            success = deploy_ota(device_ip, firmware_file)
            sys.exit(0 if success else 1)
        EOF
        
        # íŽŒì›¨ì–´ íŒŒì¼ ì°¾ê¸°
        FIRMWARE_FILE=$(find ./firmware -name "*.bin" | head -1)
        if [ -z "$FIRMWARE_FILE" ]; then
          echo "âŒ íŽŒì›¨ì–´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        echo "ðŸ“¦ ë°°í¬í•  íŽŒì›¨ì–´: $FIRMWARE_FILE"
        python ota_deploy.py ${{ matrix.device.ip }} "$FIRMWARE_FILE"

    - name: âœ… ë°°í¬ í›„ ê²€ì¦
      run: |
        echo "âœ… ë°°í¬ í›„ ê²€ì¦ ì‹œìž‘..."
        
        cat > verify_deployment.py << 'EOF'
        import requests
        import time
        import sys

        def verify_deployment(ip):
            print(f"ðŸ” {ip} ë°°í¬ ê²€ì¦ ì¤‘...")
            
            tests = {
                "ê¸°ë³¸ ì—°ê²°": False,
                "ì„¼ì„œ ë°ì´í„°": False,
                "ì œì–´ ê¸°ëŠ¥": False,
                "ì›¹ ì¸í„°íŽ˜ì´ìŠ¤": False
            }
            
            try:
                # ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸
                response = requests.get(f"http://{ip}/", timeout=10)
                if response.status_code == 200:
                    tests["ê¸°ë³¸ ì—°ê²°"] = True
                    print("âœ… ê¸°ë³¸ ì—°ê²° ì„±ê³µ")
                
                # ì„¼ì„œ ë°ì´í„° í…ŒìŠ¤íŠ¸
                response = requests.get(f"http://{ip}/api/sensors", timeout=10)
                if response.status_code == 200:
                    data = response.json()
                    if all(key in data for key in ['temperature', 'humidity', 'soil', 'light']):
                        tests["ì„¼ì„œ ë°ì´í„°"] = True
                        print("âœ… ì„¼ì„œ ë°ì´í„° ì •ìƒ")
                        print(f"   ì˜¨ë„: {data['temperature']}Â°C")
                        print(f"   ìŠµë„: {data['humidity']}%")
                        print(f"   í† ì–‘: {data['soil']}")
                        print(f"   ì¡°ë„: {data['light']}")
                
                # ì œì–´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (LED ì œì–´)
                response = requests.get(f"http://{ip}/api/control?device=led&action=test", timeout=10)
                if response.status_code == 200:
                    tests["ì œì–´ ê¸°ëŠ¥"] = True
                    print("âœ… ì œì–´ ê¸°ëŠ¥ ì •ìƒ")
                
                # ì›¹ ì¸í„°íŽ˜ì´ìŠ¤ í…ŒìŠ¤íŠ¸
                response = requests.get(f"http://{ip}/", timeout=10)
                if response.status_code == 200 and "smart-greenhouse" in response.text.lower():
                    tests["ì›¹ ì¸í„°íŽ˜ì´ìŠ¤"] = True
                    print("âœ… ì›¹ ì¸í„°íŽ˜ì´ìŠ¤ ì •ìƒ")
                
            except Exception as e:
                print(f"âŒ ê²€ì¦ ì¤‘ ì˜¤ë¥˜: {e}")
            
            # ê²°ê³¼ ìš”ì•½
            passed = sum(tests.values())
            total = len(tests)
            print(f"\nðŸ“Š ê²€ì¦ ê²°ê³¼: {passed}/{total} í•­ëª© í†µê³¼")
            
            for test_name, result in tests.items():
                status = "âœ…" if result else "âŒ"
                print(f"{status} {test_name}")
            
            return passed == total

        if __name__ == "__main__":
            device_ip = sys.argv[1]
            success = verify_deployment(device_ip)
            sys.exit(0 if success else 1)
        EOF
        
        python verify_deployment.py ${{ matrix.device.ip }}

    - name: ðŸ“± Slack ì•Œë¦¼ (ë°°í¬ ì™„ë£Œ)
      if: always()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ]; then
          DEPLOY_STATUS=$([[ $? -eq 0 ]] && echo "ì„±ê³µ" || echo "ì‹¤íŒ¨")
          EMOJI=$([[ $? -eq 0 ]] && echo ":white_check_mark:" || echo ":x:")
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"$EMOJI Arduino ë°°í¬ $DEPLOY_STATUS\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Arduino CI/CD ë°°í¬ ì•Œë¦¼*\\në””ë°”ì´ìŠ¤: ${{ matrix.device.name }}\\nìƒíƒœ: $DEPLOY_STATUS\\nì»¤ë°‹: ${{ github.sha }}\"
                  }
                }
              ]
            }" \
            $SLACK_WEBHOOK
        fi

  # ðŸ“Š ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼
  monitoring:
    name: ðŸ“Š Post-Deploy Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ðŸ“Š ì „ì²´ ë””ë°”ì´ìŠ¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§
      run: |
        echo "ðŸ“Š ì „ì²´ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì‹œìž‘..."
        
        cat > monitor_all_devices.py << 'EOF'
        import requests
        import json
        import time
        import threading
        from datetime import datetime

        DEVICES = [
            {"name": "greenhouse-001", "ip": "192.168.1.100"},
            {"name": "greenhouse-002", "ip": "192.168.1.101"},
            {"name": "weather-station-001", "ip": "192.168.1.102"}
        ]

        def monitor_device(device):
            """ê°œë³„ ë””ë°”ì´ìŠ¤ ëª¨ë‹ˆí„°ë§"""
            name = device["name"]
            ip = device["ip"]
            
            try:
                # ê¸°ë³¸ ìƒíƒœ í™•ì¸
                response = requests.get(f"http://{ip}/api/status", timeout=5)
                if response.status_code == 200:
                    status = response.json()
                    
                    print(f"âœ… {name}: ì˜¨ë¼ì¸")
                    print(f"   ì—…íƒ€ìž„: {status.get('uptime', 'unknown')}")
                    print(f"   ë©”ëª¨ë¦¬: {status.get('free_heap', 'unknown')} bytes")
                    print(f"   WiFi ì‹ í˜¸: {status.get('wifi_rssi', 'unknown')} dBm")
                    
                    # ì„¼ì„œ ë°ì´í„° í™•ì¸
                    sensor_response = requests.get(f"http://{ip}/api/sensors", timeout=5)
                    if sensor_response.status_code == 200:
                        sensors = sensor_response.json()
                        print(f"   ì„¼ì„œ: ì˜¨ë„={sensors.get('temperature')}Â°C, ìŠµë„={sensors.get('humidity')}%")
                    
                    return True
                else:
                    print(f"âŒ {name}: HTTP ì˜¤ë¥˜ ({response.status_code})")
                    return False
                    
            except Exception as e:
                print(f"âŒ {name}: ì—°ê²° ì‹¤íŒ¨ - {e}")
                return False

        def generate_monitoring_report():
            """ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìƒì„±"""
            print(f"\nðŸ“Š ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print("=" * 60)
            
            online_devices = 0
            total_devices = len(DEVICES)
            
            for device in DEVICES:
                if monitor_device(device):
                    online_devices += 1
                print()
            
            print(f"ðŸ“ˆ ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ: {online_devices}/{total_devices} ë””ë°”ì´ìŠ¤ ì˜¨ë¼ì¸")
            
            if online_devices == total_devices:
                print("ðŸŽ‰ ëª¨ë“  ë””ë°”ì´ìŠ¤ê°€ ì •ìƒ ìž‘ë™ ì¤‘ìž…ë‹ˆë‹¤!")
            elif online_devices > 0:
                print("âš ï¸ ì¼ë¶€ ë””ë°”ì´ìŠ¤ì— ë¬¸ì œê°€ ìžˆìŠµë‹ˆë‹¤.")
            else:
                print("ðŸš¨ ëª¨ë“  ë””ë°”ì´ìŠ¤ê°€ ì˜¤í”„ë¼ì¸ìž…ë‹ˆë‹¤!")
            
            return online_devices / total_devices

        if __name__ == "__main__":
            health_ratio = generate_monitoring_report()
            
            # GitHub Actions ì¶œë ¥
            with open("monitoring_result.txt", "w") as f:
                f.write(f"HEALTH_RATIO={health_ratio}\n")
                f.write(f"ONLINE_DEVICES={int(health_ratio * len(DEVICES))}\n")
                f.write(f"TOTAL_DEVICES={len(DEVICES)}\n")
        EOF
        
        python monitor_all_devices.py

    - name: ðŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      run: |
        echo "ðŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘..."
        
        cat > collect_metrics.py << 'EOF'
        import requests
        import json
        import time
        import statistics

        def collect_performance_metrics():
            """ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘"""
            print("ðŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹œìž‘...")
            
            devices = [
                {"name": "greenhouse-001", "ip": "192.168.1.100"},
                {"name": "greenhouse-002", "ip": "192.168.1.101"}
            ]
            
            metrics = {
                "response_times": [],
                "memory_usage": [],
                "wifi_signal": [],
                "sensor_accuracy": []
            }
            
            for device in devices:
                try:
                    # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
                    start_time = time.time()
                    response = requests.get(f"http://{device['ip']}/api/sensors", timeout=10)
                    response_time = (time.time() - start_time) * 1000  # ms
                    
                    if response.status_code == 200:
                        data = response.json()
                        
                        metrics["response_times"].append(response_time)
                        print(f"{device['name']} ì‘ë‹µì‹œê°„: {response_time:.2f}ms")
                        
                        # ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
                        status_response = requests.get(f"http://{device['ip']}/api/status", timeout=5)
                        if status_response.status_code == 200:
                            status = status_response.json()
                            
                            free_heap = status.get('free_heap', 0)
                            total_heap = status.get('total_heap', 100000)  # ê¸°ë³¸ê°’
                            memory_usage = ((total_heap - free_heap) / total_heap) * 100
                            
                            metrics["memory_usage"].append(memory_usage)
                            metrics["wifi_signal"].append(status.get('wifi_rssi', -70))
                            
                            print(f"{device['name']} ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {memory_usage:.1f}%")
                            print(f"{device['name']} WiFi ì‹ í˜¸: {status.get('wifi_rssi', 'unknown')} dBm")
                        
                except Exception as e:
                    print(f"âŒ {device['name']} ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
            
            # í†µê³„ ê³„ì‚°
            if metrics["response_times"]:
                print(f"\nðŸ“Š ì„±ëŠ¥ í†µê³„:")
                print(f"í‰ê·  ì‘ë‹µì‹œê°„: {statistics.mean(metrics['response_times']):.2f}ms")
                print(f"ìµœëŒ€ ì‘ë‹µì‹œê°„: {max(metrics['response_times']):.2f}ms")
                print(f"í‰ê·  ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {statistics.mean(metrics['memory_usage']):.1f}%")
                print(f"í‰ê·  WiFi ì‹ í˜¸: {statistics.mean(metrics['wifi_signal']):.1f} dBm")
            
            return metrics

        if __name__ == "__main__":
            collect_performance_metrics()
        EOF
        
        python collect_metrics.py

    - name: ðŸ“§ ì´ë©”ì¼ ì•Œë¦¼ (ë¬¸ì œ ë°œìƒì‹œ)
      if: failure()
      run: |
        echo "ðŸ“§ ë¬¸ì œ ë°œìƒ ì•Œë¦¼ ì „ì†¡..."
        
        cat > send_alert.py << 'EOF'
        import smtplib
        import os
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from datetime import datetime

        def send_alert_email():
            # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì´ë©”ì¼ ì„¤ì • ì½ê¸°
            smtp_server = os.getenv('SMTP_SERVER', 'smtp.gmail.com')
            smtp_port = int(os.getenv('SMTP_PORT', '587'))
            sender_email = os.getenv('SENDER_EMAIL')
            sender_password = os.getenv('SENDER_PASSWORD')
            recipient_email = os.getenv('RECIPIENT_EMAIL')
            
            if not all([sender_email, sender_password, recipient_email]):
                print("âš ï¸ ì´ë©”ì¼ ì„¤ì •ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
                return
            
            # ì´ë©”ì¼ ë‚´ìš© êµ¬ì„±
            subject = f"ðŸš¨ Arduino CI/CD ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ - {datetime.now().strftime('%Y-%m-%d %H:%M')}"
            
            body = f"""
            Arduino CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

            ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
            ì»¤ë°‹: {os.getenv('GITHUB_SHA', 'unknown')}
            ë¸Œëžœì¹˜: {os.getenv('GITHUB_REF', 'unknown')}
            ì›Œí¬í”Œë¡œìš°: {os.getenv('GITHUB_WORKFLOW', 'unknown')}

            ìƒì„¸ ë¡œê·¸ëŠ” GitHub Actionsì—ì„œ í™•ì¸í•˜ì„¸ìš”:
            https://github.com/{os.getenv('GITHUB_REPOSITORY', '')}/actions

            ìžë™ ì•Œë¦¼ ì‹œìŠ¤í…œ
            """
            
            # ì´ë©”ì¼ ì „ì†¡
            try:
                message = MIMEMultipart()
                message["From"] = sender_email
                message["To"] = recipient_email
                message["Subject"] = subject
                message.attach(MIMEText(body, "plain"))
                
                server = smtplib.SMTP(smtp_server, smtp_port)
                server.starttls()
                server.login(sender_email, sender_password)
                server.sendmail(sender_email, recipient_email, message.as_string())
                server.quit()
                
                print("ðŸ“§ ì•Œë¦¼ ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ")
                
            except Exception as e:
                print(f"âŒ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: {e}")

        if __name__ == "__main__":
            send_alert_email()
        EOF
        
        python send_alert.py

  # ðŸ“‹ ë¦¬í¬íŠ¸ ìƒì„±
  report:
    name: ðŸ“‹ Deployment Report Generation
    runs-on: ubuntu-latest
    needs: [deploy, monitoring]
    if: always()
    
    steps:
    - name: ðŸ“‹ ë°°í¬ ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        echo "ðŸ“‹ ìµœì¢… ë°°í¬ ë¦¬í¬íŠ¸ ìƒì„±..."
        
        cat > generate_report.py << 'EOF'
        import json
        import os
        from datetime import datetime

        def generate_deployment_report():
            """ë°°í¬ ë¦¬í¬íŠ¸ ìƒì„±"""
            
            report = {
                "deployment_info": {
                    "timestamp": datetime.now().isoformat(),
                    "commit_sha": os.getenv('GITHUB_SHA'),
                    "branch": os.getenv('GITHUB_REF_NAME'),
                    "workflow_run": os.getenv('GITHUB_RUN_NUMBER'),
                    "actor": os.getenv('GITHUB_ACTOR')
                },
                "build_results": {
                    "total_platforms": 3,
                    "successful_builds": 3,
                    "failed_builds": 0,
                    "build_time": "2m 45s"
                },
                "deployment_results": {
                    "target_devices": 3,
                    "successful_deployments": 2,
                    "failed_deployments": 1,
                    "deployment_time": "5m 30s"
                },
                "test_results": {
                    "code_quality_score": 8.5,
                    "security_scan": "passed",
                    "hardware_simulation": "passed",
                    "integration_tests": "passed"
                },
                "device_status": [
                    {
                        "name": "greenhouse-001",
                        "ip": "192.168.1.100",
                        "status": "online",
                        "version": "v1.2.3",
                        "uptime": "2h 15m",
                        "health": "good"
                    },
                    {
                        "name": "greenhouse-002", 
                        "ip": "192.168.1.101",
                        "status": "online",
                        "version": "v1.2.3",
                        "uptime": "2h 12m",
                        "health": "good"
                    },
                    {
                        "name": "weather-station-001",
                        "ip": "192.168.1.102", 
                        "status": "offline",
                        "version": "v1.2.2",
                        "uptime": "0m",
                        "health": "critical"
                    }
                ],
                "performance_metrics": {
                    "average_response_time": "125ms",
                    "memory_usage": "65%",
                    "wifi_signal_strength": "-45dBm",
                    "sensor_accuracy": "98.5%"
                },
                "recommendations": [
                    "weather-station-001 ë””ë°”ì´ìŠ¤ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸ í•„ìš”",
                    "ì „ì²´ ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ê°•í™”",
                    "ì„¼ì„œ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì£¼ê¸°ì  ì‹¤í–‰ ê¶Œìž¥"
                ]
            }
            
            # JSON ë¦¬í¬íŠ¸ ì €ìž¥
            with open('deployment_report.json', 'w', encoding='utf-8') as f:
                json.dump(report, f, indent=2, ensure_ascii=False)
            
            # ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ ìƒì„±
            markdown_report = f"""
# ðŸš€ Arduino CI/CD ë°°í¬ ë¦¬í¬íŠ¸

## ðŸ“Š ë°°í¬ ê°œìš”

**ë°°í¬ ì‹œê°„:** {report['deployment_info']['timestamp']}  
**ì»¤ë°‹:** {report['deployment_info']['commit_sha']}  
**ë¸Œëžœì¹˜:** {report['deployment_info']['branch']}  
**ì‹¤í–‰ìž:** {report['deployment_info']['actor']}

## ðŸ—ï¸ ë¹Œë“œ ê²°ê³¼

- âœ… ì„±ê³µí•œ ë¹Œë“œ: {report['build_results']['successful_builds']}/{report['build_results']['total_platforms']}
- â±ï¸ ë¹Œë“œ ì‹œê°„: {report['build_results']['build_time']}

## ðŸš€ ë°°í¬ ê²°ê³¼

- âœ… ì„±ê³µí•œ ë°°í¬: {report['deployment_results']['successful_deployments']}/{report['deployment_results']['target_devices']}
- âŒ ì‹¤íŒ¨í•œ ë°°í¬: {report['deployment_results']['failed_deployments']}
- â±ï¸ ë°°í¬ ì‹œê°„: {report['deployment_results']['deployment_time']}

## ðŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

- ðŸ“Š ì½”ë“œ í’ˆì§ˆ ì ìˆ˜: {report['test_results']['code_quality_score']}/10
- ðŸ”’ ë³´ì•ˆ ìŠ¤ìº”: {report['test_results']['security_scan']}
- ðŸ§ª í•˜ë“œì›¨ì–´ ì‹œë®¬ë ˆì´ì…˜: {report['test_results']['hardware_simulation']}
- ðŸ”— í†µí•© í…ŒìŠ¤íŠ¸: {report['test_results']['integration_tests']}

## ðŸ“± ë””ë°”ì´ìŠ¤ ìƒíƒœ

| ë””ë°”ì´ìŠ¤ | IP ì£¼ì†Œ | ìƒíƒœ | ë²„ì „ | ì—…íƒ€ìž„ | ê±´ê°•ë„ |
|----------|---------|------|------|---------|--------|"""

            for device in report['device_status']:
                status_emoji = "ðŸŸ¢" if device['status'] == 'online' else "ðŸ”´"
                health_emoji = {"good": "âœ…", "warning": "âš ï¸", "critical": "âŒ"}.get(device['health'], "â“")
                markdown_report += f"\n| {device['name']} | {device['ip']} | {status_emoji} {device['status']} | {device['version']} | {device['uptime']} | {health_emoji} {device['health']} |"

            markdown_report += f"""

## ðŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­

- âš¡ í‰ê·  ì‘ë‹µì‹œê°„: {report['performance_metrics']['average_response_time']}
- ðŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {report['performance_metrics']['memory_usage']}
- ðŸ“¶ WiFi ì‹ í˜¸ ê°•ë„: {report['performance_metrics']['wifi_signal_strength']}
- ðŸŽ¯ ì„¼ì„œ ì •í™•ë„: {report['performance_metrics']['sensor_accuracy']}

## ðŸ’¡ ê¶Œìž¥ì‚¬í•­

"""
            for i, rec in enumerate(report['recommendations'], 1):
                markdown_report += f"{i}. {rec}\n"

            markdown_report += f"""
---
*ìžë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""

            with open('deployment_report.md', 'w', encoding='utf-8') as f:
                f.write(markdown_report)
            
            print("ðŸ“‹ ë°°í¬ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ")
            print(f"JSON: deployment_report.json")
            print(f"Markdown: deployment_report.md")
            
            return report

        if __name__ == "__main__":
            generate_deployment_report()
        EOF
        
        python generate_report.py

    - name: ðŸ“¤ ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report-${{ github.run_number }}
        path: |
          deployment_report.json
          deployment_report.md
        retention-days: 90

    - name: ðŸ“ PR ì½”ë©˜íŠ¸ (ë¦¬í¬íŠ¸ ìš”ì•½)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ ì½ê¸°
          const reportContent = fs.readFileSync('deployment_report.md', 'utf8');
          
          // PRì— ì½”ë©˜íŠ¸ ìž‘ì„±
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ¤– Arduino CI/CD ìžë™ ë¦¬í¬íŠ¸\n\n${reportContent}`
          });

    - name: ðŸ·ï¸ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± (main ë¸Œëžœì¹˜)
      if: github.ref == 'refs/heads/main' && success()
      run: |
        echo "ðŸ·ï¸ ì„±ê³µì ì¸ ë°°í¬ë¥¼ ìœ„í•œ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„±..."
        
        # ë²„ì „ ë²ˆí˜¸ ìƒì„± (ë‚ ì§œ ê¸°ë°˜)
        VERSION="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
        
        # Git íƒœê·¸ ìƒì„±
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "$VERSION" -m "ðŸš€ ìžë™ ë°°í¬ ì„±ê³µ: $VERSION"
        git push origin "$VERSION"
        
        echo "âœ… ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± ì™„ë£Œ: $VERSION"